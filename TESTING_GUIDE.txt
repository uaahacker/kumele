# Kumele AI/ML Backend - Complete Testing Guide

## üìã Table of Contents
- [Quick Start](#quick-start)
- [Testing from Swagger UI](#testing-from-swagger-ui)
- [Common Testing Issues & Solutions](#common-testing-issues--solutions)
- [API Endpoints Reference](#api-endpoints-reference)
- [Step-by-Step Testing Guides](#step-by-step-testing-guides)
- [Configuration](#configuration)

---

## üöÄ Quick Start

### 1. Start the Services
```bash
# Using Docker Compose
docker-compose up -d

# Or run locally
pip install -r requirements.txt
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 2. Access Swagger UI
Open your browser and go to:
```
http://localhost:8000/docs
```

### 3. Check System Health
Before testing, verify all services are running:
```
GET /ai/health
```

---

## üß™ Testing from Swagger UI

### The Problem You Had
> "It was asking for content_id and user_id and I cannot create that on the frontend"

### ‚úÖ The Solution: Testing Helpers

We've added a **Testing Helpers** section in Swagger UI (`/testing/*`) that generates all the IDs and sample data you need!

### Step 1: Generate Test IDs

1. Go to Swagger UI: `http://localhost:8000/docs`
2. Find the **Testing Helpers** section
3. Click on `GET /testing/generate-uuid`
4. Click "Try it out" ‚Üí "Execute"
5. Copy the generated UUID
6. Use it in any endpoint that requires `user_id`, `content_id`, `event_id`, etc.

### Step 2: Generate Complete Test Data

| Endpoint | What It Generates |
|----------|-------------------|
| `GET /testing/generate-uuid` | A single UUID for any ID field |
| `GET /testing/generate-test-user` | User ID + hobbies + location with lat/lon |
| `GET /testing/generate-test-event` | Event ID + host ID + category + date |
| `GET /testing/generate-test-content` | Content ID + sample texts for moderation |
| `GET /testing/generate-test-ad` | Ad ID + targeting parameters |
| `GET /testing/sample-api-calls` | Ready-to-copy request bodies for ALL APIs |

### Step 3: Quick Test Endpoints (No IDs Needed!)

These endpoints let you test immediately without generating IDs:

| Endpoint | What It Tests |
|----------|---------------|
| `POST /testing/test-text-moderation` | Just type text ‚Üí get moderation result |
| `POST /testing/test-sentiment` | Just type text ‚Üí get sentiment analysis |
| `POST /testing/test-keywords` | Just type text ‚Üí get keywords |
| `POST /testing/test-chatbot` | Just type question ‚Üí get answer |
| `POST /testing/test-translation` | Just type text ‚Üí get translation |

---

## ‚ùì Common Testing Issues & Solutions

### Issue 1: "I need a user_id/content_id but can't create one"

**Solution:** 
1. Go to `GET /testing/generate-uuid`
2. Click "Try it out" ‚Üí "Execute"
3. Copy the UUID from the response
4. Paste it wherever `user_id` or `content_id` is required

**Or use the quick test endpoints that don't require IDs!**

### Issue 2: "No file upload for image moderation"

**Solution:** The moderation API uses URLs, not file uploads. Options:

1. **Use a public image URL:**
   - Wikipedia images (safe for testing)
   - Any publicly accessible image URL
   
2. **Use test images from our endpoint:**
   ```
   GET /testing/generate-test-content
   ```
   This gives you sample image URLs to use.

3. **Upload your own image:**
   - Use `POST /testing/upload-image` to upload
   - Then host the image somewhere public
   - Use that URL in moderation API

**Example image moderation request:**
```json
{
  "content_id": "550e8400-e29b-41d4-a716-446655440000",
  "content_type": "image",
  "image_url": "https://upload.wikimedia.org/wikipedia/commons/thumb/4/47/PNG_transparency_demonstration_1.png/280px-PNG_transparency_demonstration_1.png",
  "user_id": "550e8400-e29b-41d4-a716-446655440001"
}
```

### Issue 3: "What values should I use for lat/lon?"

**Solution:** Use one of these common locations:

| City | Latitude | Longitude |
|------|----------|-----------|
| New York | 40.7128 | -74.0060 |
| Los Angeles | 34.0522 | -118.2437 |
| Chicago | 41.8781 | -87.6298 |
| London | 51.5074 | -0.1278 |
| Paris | 48.8566 | 2.3522 |
| Tokyo | 35.6762 | 139.6503 |

Or use `GET /testing/generate-test-user` which includes location data!

### Issue 4: "What categories/hobbies can I use?"

**Available categories:**
```
photography, hiking, cooking, gaming, music, reading, yoga, 
painting, dancing, gardening, cycling, swimming, running, 
chess, crafts, fitness, travel, technology, art, sports
```

### Issue 5: "What languages are supported?"

| Code | Language |
|------|----------|
| en | English |
| fr | French |
| es | Spanish |
| de | German |
| zh | Chinese |
| ar | Arabic |

---

## üìö API Endpoints Reference

### üß™ Testing Helpers (`/testing`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/testing/generate-uuid` | Generate a UUID for testing |
| GET | `/testing/generate-test-user` | Generate complete user test data |
| GET | `/testing/generate-test-event` | Generate event test data |
| GET | `/testing/generate-test-content` | Generate content for moderation |
| GET | `/testing/generate-test-ad` | Generate ad test data |
| GET | `/testing/sample-api-calls` | Get sample requests for all APIs |
| POST | `/testing/upload-image` | Upload image for testing |
| POST | `/testing/test-text-moderation` | Quick text moderation test |
| POST | `/testing/test-sentiment` | Quick sentiment test |
| POST | `/testing/test-keywords` | Quick keyword extraction test |
| POST | `/testing/test-chatbot` | Quick chatbot test |
| POST | `/testing/test-translation` | Quick translation test |

### ‚≠ê Rating System (`/rating`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/rating/event/{event_id}` | Submit event rating |
| GET | `/rating/host/{host_id}` | Get host's rating |
| GET | `/rating/host/{host_id}/badges` | Get host's badges |

**Test it:**
```json
// POST /rating/event/550e8400-e29b-41d4-a716-446655440000
{
  "user_id": "550e8400-e29b-41d4-a716-446655440001",
  "rating": 5,
  "feedback": "Great event!"
}
```

### üéØ Recommendations (`/recommendations`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/recommendations/hobbies` | Get hobby recommendations |
| GET | `/recommendations/events` | Get event recommendations |
| POST | `/recommendations/refresh/{user_id}` | Refresh recommendations |

**Test it:**
```
GET /recommendations/hobbies?user_id=550e8400-e29b-41d4-a716-446655440000&limit=10
GET /recommendations/events?user_id=550e8400-e29b-41d4-a716-446655440000&limit=10
```

### üì¢ Advertising (`/ads`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/ads/audience-match` | Match ad to audience segments |
| POST | `/ads/performance-predict` | Predict ad performance |
| GET | `/ads/segments` | List audience segments |

**Test it:**
```json
// POST /ads/audience-match
{
  "ad_id": "550e8400-e29b-41d4-a716-446655440000",
  "ad_content": "Join our photography community!",
  "target_interests": ["photography", "art"],
  "target_locations": ["New York"],
  "target_age_min": 18,
  "target_age_max": 45
}
```

### üìù NLP Services (`/nlp`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/nlp/sentiment` | Analyze text sentiment |
| POST | `/nlp/keywords` | Extract keywords |
| GET | `/nlp/trends` | Get trending topics |
| POST | `/nlp/batch-sentiment` | Batch sentiment analysis |

**Test it:**
```json
// POST /nlp/sentiment
{
  "text": "I absolutely loved this hiking event! The views were amazing."
}

// POST /nlp/keywords
{
  "text": "Photography workshop in downtown Chicago near the Art Institute",
  "max_keywords": 10
}
```

### üõ°Ô∏è Moderation (`/moderation`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/moderation` | Moderate content |
| GET | `/moderation/{content_id}` | Get moderation status |
| POST | `/moderation/review/{content_id}` | Manual review |
| GET | `/moderation/queue` | Get moderation queue |

**Test TEXT moderation:**
```json
// POST /moderation
{
  "content_id": "550e8400-e29b-41d4-a716-446655440000",
  "content_type": "text",
  "text": "This is a great event! Really enjoyed it.",
  "user_id": "550e8400-e29b-41d4-a716-446655440001"
}
```

**Test IMAGE moderation:**
```json
// POST /moderation
{
  "content_id": "550e8400-e29b-41d4-a716-446655440000",
  "content_type": "image",
  "image_url": "https://example.com/image.jpg",
  "user_id": "550e8400-e29b-41d4-a716-446655440001"
}
```

### ü§ñ Chatbot (`/chatbot`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/chatbot/ask` | Ask a question |
| POST | `/chatbot/sync` | Sync knowledge document |
| POST | `/chatbot/feedback` | Submit feedback |
| GET | `/chatbot/sessions/{user_id}` | Get chat sessions |

**Test it:**
```json
// POST /chatbot/ask
{
  "query": "How do I create an event?",
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "language": "en"
}
```

### üåê Translation (`/translate`, `/i18n`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/translate` | Translate text |
| GET | `/translate/detect` | Detect language |
| GET | `/translate/languages` | List supported languages |
| GET | `/i18n/{language}` | Get UI strings |

**Test it:**
```json
// POST /translate
{
  "text": "Hello, how are you?",
  "source_language": "en",
  "target_language": "fr"
}
```

### üèÜ Rewards & Gamification (`/rewards`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/rewards/suggestion` | Get reward suggestion |
| GET | `/rewards/progress/{user_id}` | Get reward progress |
| POST | `/rewards/redeem/{coupon_id}` | Redeem coupon |
| GET | `/rewards/coupons/{user_id}` | Get user coupons |

**Tier System:**
| Tier | Events (30 days) | Discount |
|------|------------------|----------|
| Bronze | 1+ | 0% |
| Silver | 3+ | 4% |
| Gold | 4+ | 8% (stacks!) |

**Test it:**
```
GET /rewards/suggestion?user_id=550e8400-e29b-41d4-a716-446655440000
```

### üó∫Ô∏è Event Matching (`/match`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/match/events` | Get matched events |
| GET | `/match/score-breakdown/{event_id}` | Get score breakdown |
| POST | `/match/geocode` | Convert address to lat/lon |

**Test it:**
```
GET /match/events?user_id=550e8400-e29b-41d4-a716-446655440000&lat=40.7128&lon=-74.0060&max_distance_km=50
```

### üìä Predictions (`/predict`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/predict/attendance` | Predict event attendance |
| GET | `/predict/trends` | Get best day/time trends |
| GET | `/predict/demand/{category}` | Predict category demand |
| GET | `/predict/no-show-rate` | Predict no-show rate |

**Test attendance prediction:**
```json
// POST /predict/attendance
{
  "event_id": "550e8400-e29b-41d4-a716-446655440000",
  "event_date": "2025-12-25T14:00:00",
  "category": "photography",
  "location": "New York",
  "capacity": 50,
  "host_id": "550e8400-e29b-41d4-a716-446655440001"
}
```

**Test trends:**
```
GET /predict/trends?category=photography&location=New%20York
GET /predict/no-show-rate?category=photography&is_free=true&days_until_event=7
```

### üí∞ Pricing (`/pricing`, `/discount`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/pricing/dynamic` | Get dynamic pricing |
| GET | `/pricing/market/{category}` | Get market analysis |
| POST | `/discount/validate` | Validate discount code |

### üìß Support (`/support`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/support/analyze` | Analyze support email |
| POST | `/support/route` | Route support ticket |
| GET | `/support/queue` | Get support queue |

### üè∑Ô∏è Taxonomy (`/taxonomy`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/taxonomy/sync` | Sync categories |
| GET | `/taxonomy/categories` | Get all categories |
| GET | `/taxonomy/search` | Search categories |

### üîß System (`/ai`)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/ai/health` | Full system health check |
| GET | `/ai/health/simple` | Simple health check |
| GET | `/ai/metrics` | System metrics |

---

## üìù Step-by-Step Testing Guides

### Guide 1: Test Text Moderation (Easiest Way)

1. Go to `http://localhost:8000/docs`
2. Scroll to **Testing Helpers**
3. Click `POST /testing/test-text-moderation`
4. Click "Try it out"
5. Enter any text in the `text` field
6. Click "Execute"
7. See the moderation result!

### Guide 2: Test Full Moderation API

1. Go to `GET /testing/generate-test-content`
2. Click "Try it out" ‚Üí "Execute"
3. Copy the `content_id` and `user_id` from response
4. Go to `POST /moderation`
5. Click "Try it out"
6. Paste this (with your IDs):
```json
{
  "content_id": "YOUR_CONTENT_ID",
  "content_type": "text",
  "text": "I really enjoyed this event!",
  "user_id": "YOUR_USER_ID"
}
```
7. Click "Execute"

### Guide 3: Test Image Moderation

1. Go to `GET /testing/generate-test-content`
2. Click "Try it out" ‚Üí "Execute"
3. Copy the `content_id` and an `image_url` from `sample_images`
4. Go to `POST /moderation`
5. Use this request:
```json
{
  "content_id": "YOUR_CONTENT_ID",
  "content_type": "image",
  "image_url": "https://upload.wikimedia.org/wikipedia/commons/thumb/4/47/PNG_transparency_demonstration_1.png/280px-PNG_transparency_demonstration_1.png",
  "user_id": "YOUR_USER_ID"
}
```

### Guide 4: Test Event Matching

1. Go to `GET /testing/generate-test-user`
2. Click "Try it out" ‚Üí "Execute"
3. Copy `user_id`, `lat`, and `lon` from response
4. Go to `GET /match/events`
5. Fill in the parameters:
   - `user_id`: paste your user_id
   - `lat`: paste the latitude (e.g., 40.7128)
   - `lon`: paste the longitude (e.g., -74.0060)
   - `max_distance_km`: 50
6. Click "Execute"

### Guide 5: Test Attendance Prediction

1. Go to `GET /testing/generate-test-event`
2. Click "Try it out" ‚Üí "Execute"  
3. Copy the `usage_in_apis./predict/attendance` object
4. Go to `POST /predict/attendance`
5. Paste the entire request body
6. Click "Execute"

### Guide 6: Test Chatbot

**Quick way:**
1. Go to `POST /testing/test-chatbot`
2. Enter your question
3. Click "Execute"

**Full way:**
1. Generate a user_id from `/testing/generate-uuid`
2. Go to `POST /chatbot/ask`
3. Use:
```json
{
  "query": "How do I create an event?",
  "user_id": "YOUR_USER_ID",
  "language": "en"
}
```

---

## ‚öôÔ∏è Configuration

### Environment Variables

Create a `.env` file based on `.env.example`:

```bash
# Database
DATABASE_URL=postgresql+asyncpg://user:pass@localhost:5432/kumele

# Redis
REDIS_URL=redis://localhost:6379

# Vector Database (Qdrant)
QDRANT_HOST=localhost
QDRANT_PORT=6333

# LLM Configuration
LLM_MODE=external          # "internal" or "external"
MISTRAL_API_KEY=your-key   # For external mode
TGI_URL=http://tgi:80      # For internal mode

# HuggingFace (for image moderation)
HUGGINGFACE_API_KEY=your-key
IMAGE_ANALYSIS_ENABLED=true

# Translation
TRANSLATE_URL=http://libretranslate:5000
```

### Docker Compose

```bash
# Start all services
docker-compose up -d

# Check logs
docker-compose logs -f app

# Stop services
docker-compose down
```

---

## üîç Troubleshooting

### "Internal Server Error"
- Check if all services are running: `GET /ai/health`
- Check Docker logs: `docker-compose logs app`

### "Connection refused" errors
- Make sure database, Redis, Qdrant are running
- Check the URLs in `.env` match your setup

### Moderation returns low confidence
- This is normal for test data
- Real models need to be configured (see `.env`)

### Chatbot returns generic answers
- Sync knowledge base first: `POST /chatbot/sync`
- Or check LLM configuration

---

## üìû Support

If you have issues:
1. Check `/ai/health` for service status
2. Check Docker logs
3. Verify `.env` configuration
4. Try the quick test endpoints first

---

**Happy Testing! üöÄ**
